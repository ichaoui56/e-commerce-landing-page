generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @db.VarChar(255)
  email         String   @unique @db.VarChar(255)
  password_hash String   @db.VarChar(255)
  created_at    DateTime @default(now())

  @@map("users")
}

model Category {
  id       String     @id @default(uuid()) @db.Uuid
  name     String
  slug     String     @unique
  parentId String?    @db.Uuid
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("category")
}

model Color {
  id            String         @id @default(uuid()) @db.Uuid
  name          String         @db.VarChar(50)
  hex           String?        @db.VarChar(10)
  productColors ProductColor[]

  @@map("colors")
}

model Size {
  id                String             @id @default(uuid()) @db.Uuid
  label             String             @unique @db.VarChar(10)
  productSizeStocks ProductSizeStock[]

  @@map("sizes")
}

model Product {
  id               String         @id @default(uuid()) @db.Uuid
  name             String         @db.VarChar(255)
  description      String?
  category_id      String?        @db.Uuid
  solde_percentage Int?
  top_price        Boolean        @default(false)
  created_at       DateTime       @default(now())
  updated_at       DateTime       @default(now()) @updatedAt
  likes            Like[]
  productColors    ProductColor[]
  category         Category?      @relation(fields: [category_id], references: [id])

  @@map("products")
}

model ProductColor {
  id                String             @id @default(uuid()) @db.Uuid
  product_id        String             @db.Uuid
  color_id          String             @db.Uuid
  image_url         String?
  color             Color              @relation(fields: [color_id], references: [id])
  product           Product            @relation(fields: [product_id], references: [id], onDelete: Cascade)
  product_images    product_images[]
  productSizeStocks ProductSizeStock[]

  @@unique([product_id, color_id])
  @@map("product_colors")
}

model ProductSizeStock {
  id               String       @id @default(uuid()) @db.Uuid
  product_color_id String       @db.Uuid
  size_id          String       @db.Uuid
  stock            Int          @default(0)
  price            Decimal      @db.Decimal(10, 2)
  reserved_stock   Int          @default(0)
  orderItems       OrderItem[]
  panelItems       PanelItem[]
  productColor     ProductColor @relation(fields: [product_color_id], references: [id], onDelete: Cascade)
  size             Size         @relation(fields: [size_id], references: [id])

  @@unique([product_color_id, size_id])
  @@map("product_size_stocks")
}

model GuestUser {
  session_id String      @id @db.VarChar(255)
  created_at DateTime    @default(now())
  expires_at DateTime
  likes      Like[]
  orders     Order[]
  panelItems PanelItem[]

  @@map("guest_users")
}

model Like {
  id               String    @id @default(uuid()) @db.Uuid
  guest_session_id String    @db.VarChar(255)
  product_id       String    @db.Uuid
  liked_at         DateTime  @default(now())
  guestUser        GuestUser @relation(fields: [guest_session_id], references: [session_id], onDelete: Cascade)
  product          Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([guest_session_id, product_id])
  @@map("likes")
}

model PanelItem {
  id                    String           @id @default(uuid()) @db.Uuid
  guest_session_id      String           @db.VarChar(255)
  product_size_stock_id String           @db.Uuid
  quantity              Int
  added_at              DateTime         @default(now())
  guestUser             GuestUser        @relation(fields: [guest_session_id], references: [session_id], onDelete: Cascade)
  productSizeStock      ProductSizeStock @relation(fields: [product_size_stock_id], references: [id], onDelete: Cascade)

  @@unique([guest_session_id, product_size_stock_id])
  @@map("panel_items")
}

model Order {
  id               String      @id @default(uuid()) @db.Uuid
  guest_session_id String      @db.VarChar(255)
  ref_id           String      @unique @db.VarChar(50)
  name             String      @db.VarChar(255)
  phone            String      @db.VarChar(50)
  status           OrderStatus @default(pending)
  created_at       DateTime    @default(now())
  city             String
  shipping_cost    Decimal     @default(0) @db.Decimal(10, 2)
  shipping_option  String?     @db.VarChar(100)
  approved_by      String?     @db.VarChar(255)
  confirmed_at     DateTime?
  stock_reduced    Boolean     @default(false)
  stock_reserved   Boolean     @default(false)
  orderItems       OrderItem[]
  guestUser        GuestUser   @relation(fields: [guest_session_id], references: [session_id], onDelete: Cascade)

  @@map("orders")
}

model OrderItem {
  id                    String           @id @default(uuid()) @db.Uuid
  order_id              String           @db.Uuid
  product_size_stock_id String           @db.Uuid
  quantity              Int
  price_at_purchase     Decimal          @db.Decimal(10, 2)
  order                 Order            @relation(fields: [order_id], references: [id], onDelete: Cascade)
  productSizeStock      ProductSizeStock @relation(fields: [product_size_stock_id], references: [id])

  @@unique([order_id, product_size_stock_id])
  @@map("order_items")
}

model product_images {
  id               String       @id @db.Uuid
  product_color_id String       @db.Uuid
  image_url        String
  is_primary       Boolean      @default(false)
  sort_order       Int          @default(0)
  created_at       DateTime     @default(now())
  product_colors   ProductColor @relation(fields: [product_color_id], references: [id], onDelete: Cascade)
}

enum OrderStatus {
  pending
  shipped
  delivered
  cancelled
  confirmed
}
